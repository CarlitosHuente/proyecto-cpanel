<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Huentelauqu√©n{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/estilos.css') }}" rel="stylesheet">
    <style>
        body {
            background-color: #000;
            color: #fff;
        }
        
        /* --- ESTILOS DE ESCRITORIO (BASE) --- */
        .sidebar {
            height: 100vh;
            background-color: #111;
            padding-top: 20px;
            width: 220px;
            overflow: hidden;
            transition: width 0.2s ease, transform 0.3s ease;
            z-index: 1040;
        }
        .sidebar a {
            color: white;
            padding: 12px;
            display: block;
            text-decoration: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .sidebar a:hover {
            background-color: #d80000;
            color: white;
        }
        .main-content {
            margin-left: 220px;
            padding: 20px;
            transition: margin-left 0.2s ease;
            width: 100%;
        }
        
        body.sidebar-collapsed .sidebar { width: 70px; }
        body.sidebar-collapsed .main-content { margin-left: 70px; }
        body.sidebar-collapsed .sidebar img { width: 70px; }
        body.sidebar-collapsed .sidebar .texto-menu { display: none; }

        #loading-overlay {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.7);
            display: none; align-items: center; justify-content: center;
            flex-direction: column; z-index: 2000;
        }
        #loading-overlay .spinner {
            width: 3rem; height: 3rem; border: 0.4rem solid #fff;
            border-top-color: #d80000; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        #loading-overlay p { margin-top: 1rem; color: #fff; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- ESTILOS SOLO PARA MOVIL (Max 768px) --- */
        @media (max-width: 768px) {
            /* 1. Sidebar Flotante */
            .sidebar {
                position: fixed;
                width: 250px;
                transform: translateX(-100%);
                height: 100%;
                top: 0; left: 0;
                box-shadow: 2px 0 10px rgba(0,0,0,0.5);
            }
            .sidebar.mobile-open { transform: translateX(0); }
            .main-content { margin-left: 0 !important; padding: 10px; padding-top: 60px; }
            body.sidebar-collapsed .main-content { margin-left: 0; }

            /* 2. Ajustes de Texto */
            h2 { font-size: 1.5rem; }
            .display-6 { font-size: 1.5rem; }
            
            /* --- 3. CORRECCI√ìN CR√çTICA DE TABLAS --- */
            
            /* Forzar comportamiento de scroll */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* ROMPER EL "TABLE-LAYOUT: FIXED" DEL HTML */
            table {
                table-layout: auto !important; /* Deja que la tabla crezca lo que necesite */
                width: auto !important;        /* No la obligues a ser 100% si necesita ser 200% */
            }

            /* Celdas: No romper l√≠neas y ancho m√≠nimo */
            table th, table td {
                white-space: nowrap;  /* Texto en una sola l√≠nea */
                min-width: 110px;     /* Ancho m√≠nimo para n√∫meros */
                font-size: 0.8rem;
                padding: 0.5rem !important;
            }

            /* Primera Columna (Concepto) FIJA */
            table td:first-child, table th:first-child {
                position: sticky;
                left: 0;
                min-width: 160px;     /* M√°s ancha para el nombre */
                background-color: #222; /* Fondo para tapar el scroll */
                z-index: 5;
                border-right: 2px solid #444;
            }

            /* Header de la primera columna */
            thead th:first-child {
                z-index: 6;
                background-color: #000;
            }
            
            /* Header superior fijo */
            thead th {
                position: sticky;
                top: 0;
                background-color: #000;
                z-index: 4;
            }
        }
    </style>
</head>

<div id="loading-overlay">
    <div class="spinner"></div>
    <p>Actualizando todos los datos, por favor espere...</p>
</div>

<body>

<nav class="navbar navbar-dark bg-black fixed-top d-md-none border-bottom border-secondary" style="height: 50px; padding: 0 15px;">
    <button class="btn btn-outline-light btn-sm" id="btn-mobile-menu">
        ‚ò∞ Men√∫
    </button>
    <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" height="30">
</nav>

<div class="d-flex">
    <div class="sidebar position-fixed" id="sidebar">
        <div class="d-flex justify-content-between align-items-center px-3 d-md-none mb-3">
            <span class="text-white fw-bold">Men√∫</span>
            <button class="btn btn-sm btn-outline-danger" id="btn-close-sidebar">‚úï</button>
        </div>

        <div class="text-center mb-3 d-none d-md-block">
            <a href="/refresh" title="Actualizar datos" onclick="mostrarOverlay()">
                <img src="{{ url_for('static', filename='img/logo.png') }}" alt="Logo" width="120">
            </a>
        </div>

        <div class="text-center mb-3 d-none d-md-block">
            <button type="button" class="btn btn-outline-light btn-sm w-75" id="btn-toggle-sidebar">
                ‚ò∞
            </button>
        </div>

        {% if fecha_actualizacion %}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div style="position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; width: auto; max-width: 90%;">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                    </div>
                {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div style="font-size: 0.7rem; color: #ccc; font-style: italic; padding-left: 12px;" class="d-none d-md-block">
            Act: {{ fecha_actualizacion.strftime("%d/%m %H:%M") }}
        </div>
        {% endif %}

        {% if tiene_permiso(session.get('rol'), 'dashboard') %}
        <a href="{{ url_for('dashboard.dashboard') }}"><span class="texto-menu">Dashboard</span></a>
        {% endif %}

        {% if tiene_permiso(session.get('rol'), 'ventas') %}
        <a href="{{ url_for('ventas.ventas') }}"><span class="texto-menu">Ventas</span></a>
        {% endif %}

        {% if tiene_permiso(session.get('rol'), 'seremi') %}
        <div class="dropdown">
            <a class="dropdown-toggle d-block px-3 py-2 text-white" href="#" role="button" id="seremiDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="texto-menu">Seremi</span>
            </a>
            <ul class="dropdown-menu bg-dark border-0" aria-labelledby="seremiDropdown">
                <li><a class="dropdown-item text-white" href="{{ url_for('seremi.temperatura_equipos') }}">Temperatura Equipos</a></li>
                <li><a class="dropdown-item text-white" href="{{ url_for('seremi.temperatura_productos') }}">Temperatura Productos</a></li>
                <li><a class="dropdown-item text-white" href="{{ url_for('seremi.cambio_aceite') }}">Cambio de Aceite</a></li>
                <li><a class="dropdown-item text-white" href="{{ url_for('seremi.recepcion_mercaderia') }}">Recepcion Mercaderia</a></li>
                <li><a class="dropdown-item text-white" href="{{ url_for('seremi.personal') }}">Registro del Personal</a></li>
            </ul>
        </div>
        {% endif %}

        {% if tiene_permiso(session.get('rol'), 'sucursales') %}
        <a href="{{ url_for('sucursales.pizarra') }}">
            <span class="texto-menu">Sucursales / Pedidos</span>
        </a>
        {% endif %}

        <!--
        Modulo Finanzas
        {% if tiene_permiso(session.get('rol'), 'flujo') %}
        <div class="dropdown">
            <a class="dropdown-toggle d-block px-3 py-2 text-white" href="#" role="button" id="finanzasDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="texto-menu">Finanzas / Tesorer√≠a</span>
            </a>
            <ul class="dropdown-menu bg-dark border-0" aria-labelledby="finanzasDropdown">
                <li><a class="dropdown-item text-white" href="{{ url_for('finanzas.flujo') }}">üìä Flujo de Caja</a></li>
                <li><a class="dropdown-item text-white" href="{{ url_for('finanzas.pagos') }}">üí∏ Registrar Pago/Ingreso</a></li>
            </ul>
        </div>
        {% endif %}
        -->
        {% if tiene_permiso(session.get('rol'), 'contab') or tiene_permiso(session.get('rol'), 'reporte') %}
        <div class="dropdown">
            <a class="dropdown-toggle d-block px-3 py-2 text-white" href="#" role="button" id="contabDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <span class="texto-menu">Gesti√≥n / Contab</span>
            </a>
            <ul class="dropdown-menu bg-dark border-0" aria-labelledby="contabDropdown">
                {% if tiene_permiso(session.get('rol'), 'contab') %}
                <li><a class="dropdown-item text-white" href="{{ url_for('contab.comparativo') }}">Comparativo</a></li>
                <li><a class="dropdown-item text-white" href="{{ url_for('contab.archivos') }}">Archivos</a></li>
                <li><a class="dropdown-item text-white" href="{{ url_for('contab.prorrateos') }}">Prorrateos</a></li>
                {% endif %}
                <li><a class="dropdown-item text-white" href="{{ url_for('contab.dashboard_gestion') }}">Informe Gerencial</a></li>
                {% if tiene_permiso(session.get('rol'), 'contab') %}
                <li><hr class="dropdown-divider bg-secondary"></li>
                <li><a class="dropdown-item text-white" href="{{ url_for('contab.clasificacion_cuentas') }}">Clasificaci√≥n Cuentas</a></li>
                {% endif %}
            </ul>
        </div>
        {% endif %}

        {% if tiene_permiso(session.get('rol'), 'ventas') %} <a href="#"><span class="texto-menu">Clientes</span></a> {% endif %}

        {% if tiene_permiso(session.get('rol'), 'fabrica') %}
        <a href="{{ url_for('fabrica.calendario_produccion') }}">
            <span class="texto-menu">F√°brica Empanadas</span>
        </a>
        {% endif %}
        
        
        {% if session['rol'] in ['superusuario', 'admin', 'logistica', "seremi"] %}
        <li class="nav-item">
            <a class="nav-link collapsed text-white" href="#" data-bs-toggle="collapse" data-bs-target="#submenuConfig" aria-expanded="false">
                <i class="bi bi-gear-fill me-2"></i> Configuraci√≥n 
                <i class="bi bi-caret-down-fill ms-auto" style="font-size: 0.8em;"></i>
            </a>
            <div class="collapse" id="submenuConfig">
                <ul class="btn-toggle-nav list-unstyled fw-normal pb-1 small ms-4">
                    
                    {% if session['rol'] in ['superusuario', 'admin'] %}
                    <li><a href="{{ url_for('config.usuarios') }}" class="text-white text-decoration-none rounded p-1 d-block">
                        <i class="bi bi-people me-2"></i> Usuarios
                    </a></li>
                    {% endif %}

                    <li><a href="{{ url_for('config.productos') }}" class="text-white text-decoration-none rounded p-1 d-block">
                        <i class="bi bi-box-seam me-2"></i> Productos
                    </a></li>

                    <li><a href="{{ url_for('config.categorias') }}" class="text-white text-decoration-none rounded p-1 d-block">
                        <i class="bi bi-tags me-2"></i> Categor√≠as
                    </a></li>
                    
                </ul>
            </div>
        </li>
        {% endif %}

        
        <a href="{{ url_for('auth.logout') }}"><span class="texto-menu">Cerrar sesi√≥n</span></a>
    </div>

    <div class="main-content flex-grow-1">
        {% block content %}{% endblock %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const hash = window.location.hash;
    if (hash) {
      const tab = document.querySelector(`a[href="${hash}"]`);
      if (tab) new bootstrap.Tab(tab).show();
    }

    // Sidebar Desktop
    const colapsado = localStorage.getItem("sidebarCollapsed") === "1";
    if (colapsado) document.body.classList.add("sidebar-collapsed");

    const btnToggle = document.getElementById("btn-toggle-sidebar");
    if (btnToggle) {
      btnToggle.addEventListener("click", function () {
        document.body.classList.toggle("sidebar-collapsed");
        const ahoraColapsado = document.body.classList.contains("sidebar-collapsed");
        localStorage.setItem("sidebarCollapsed", ahoraColapsado ? "1" : "0");
      });
    }

    // Sidebar Mobile
    const btnMobile = document.getElementById("btn-mobile-menu");
    const btnClose = document.getElementById("btn-close-sidebar");
    const sidebar = document.getElementById("sidebar");

    if (btnMobile) {
        btnMobile.addEventListener("click", () => {
            sidebar.classList.add("mobile-open");
        });
    }
    if (btnClose) {
        btnClose.addEventListener("click", () => {
            sidebar.classList.remove("mobile-open");
        });
    }
    document.addEventListener("click", (e) => {
        if (window.innerWidth <= 768 && 
            sidebar.classList.contains("mobile-open") && 
            !sidebar.contains(e.target) && 
            e.target !== btnMobile) {
            sidebar.classList.remove("mobile-open");
        }
    });
  });

  function mostrarOverlay() {
    document.getElementById('loading-overlay').style.display = 'flex';
  }
</script>

<footer class="text-end text-white p-2" style="font-size: 0.8rem;">
    </footer>

</body>
</html>