{% extends "base.html" %}
{% block title %}Ventas - Huentelauquén{% endblock %}
{% block content %}

<h2 class="text-white">Ventas</h2>
<p class="text-white">Resumen general de ventas basado en datos del Google Sheet.</p>

<form id="form-filtros" method="GET" class="row g-3 mb-4 text-white">

  <input type="hidden" name="tab" id="tab" value="{{ filtros.tab or 'detalle' }}">

  <div class="col-md-3">
    <label for="empresa" class="form-label">Empresa</label>
    <select id="empresa" name="empresa" class="form-select">
      <option value="comercial" {% if empresa == "comercial" %}selected{% endif %}>Huente Comercial</option>
      <option value="agricola" {% if empresa == "agricola" %}selected{% endif %}>Huente Agrícola</option>
    </select>
  </div>

  <div class="col-md-3">
    <label for="sucursal" class="form-label">Sucursal</label>
    <select name="sucursal" class="form-select">
      {% for s in sucursales %}
        <option value="{{ s }}" {% if s == sucursal %}selected{% endif %}>{{ s }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-2">
    <label for="semana" class="form-label">Semana</label>
    <input type="number" class="form-control" id="semana" name="semana" value="{{ filtros.semana or '' }}">
  </div>

  <div class="col-md-2">
    <label for="año" class="form-label">Año</label>
    <input type="number" class="form-control" id="año" name="año" value="{{ filtros.año or '' }}">
  </div>

  <div class="col-md-2">
  <label for="dia_semana" class="form-label">Día de Semana</label>
  <select id="dia_semana" name="dia_semana" class="form-select">
    <option value="TODOS">Todos</option>
    <option value="1">Lunes</option>
    <option value="2">Martes</option>
    <option value="3">Miércoles</option>
    <option value="4">Jueves</option>
    <option value="5">Viernes</option>
    <option value="6">Sábado</option>
    <option value="7">Domingo</option>
  </select>
</div>

  <div class="col-md-3">
    <label for="desde" class="form-label">Desde</label>
    <input type="date" class="form-control" id="desde" name="desde" value="{{ filtros.desde or '' }}">
  </div>

  <div class="col-md-3">
    <label for="hasta" class="form-label">Hasta</label>
    <input type="date" class="form-control" id="hasta" name="hasta" value="{{ filtros.hasta or '' }}">
  </div>

  <div class="col-md-3">
    <label for="filtro_por" class="form-label">Filtrar por</label>
    <select id="filtro_por" name="filtro_por" class="form-select">
      <option value="FAMILIA" {% if filtro_por == "FAMILIA" %}selected{% endif %}>Familia</option>
      <option value="DESCRIPCION" {% if filtro_por == "DESCRIPCION" %}selected{% endif %}>Descripción</option>
    </select>
  </div>

  <div class="col-md-3">
    <label for="valor" class="form-label">Valor</label>
    <select id="valor" name="valor" class="form-select">
      <option value="TODOS" {% if filtro_valor == "TODOS" %}selected{% endif %}>TODOS</option>
      {% for v in opciones_valor %}
        <option value="{{ v }}" {% if v == filtro_valor %}selected{% endif %}>{{ v }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-3 d-flex align-items-end">
    <button type="submit" class="btn btn-danger w-100">Aplicar Filtro</button>
  </div>

  <div class="col-md-3 d-flex align-items-end">
    <a id="descargar-link" class="btn btn-danger w-100 text-center" href="#">Descargar Excel</a>
  </div>
</form>

<ul class="nav nav-tabs" id="ventasTabs">
  <li class="nav-item">
    <a class="nav-link {% if filtros.tab != 'resumen' %}active{% endif %}" data-bs-toggle="tab" href="#detalle">Detalle</a>
  </li>
  <li class="nav-item">
    <a class="nav-link {% if filtros.tab == 'resumen' %}active{% endif %}" data-bs-toggle="tab" href="#resumen">Resumen Mensual</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" data-bs-toggle="tab" href="#detalle_dia">Detalle por Día</a>
  </li>
</ul>

<div class="tab-content mt-3">
  <div class="tab-pane fade {% if filtros.tab != 'resumen' %}show active{% endif %}" id="detalle">
    {% if detalle %}
      <h3 class="mt-4 text-white">Detalle de Ventas</h3>
      <div class="table-responsive">
        <table class="table table-dark table-hover table-bordered mt-3">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Cantidad</th>
              <th>Neto</th>
              <th>Precio Unitario</th>
            </tr>
          </thead>
          <tbody>
            {% for fila in detalle %}
              <tr>
                <td>{{ fila["PRODUCTO"] }}</td>
                <td>{{ "%.0f"|format(fila["CANTIDAD"]) if fila["PRODUCTO"] != "TOTAL" else fila["CANTIDAD"] }}</td>
                <td>${{ "{:,.0f}".format(fila["NETO"]).replace(",", ".") }}</td>
                <td>
                  {% if fila["PRECIO_UNITARIO"] %}
                    ${{ "{:,.0f}".format(fila["PRECIO_UNITARIO"]).replace(",", ".") }}
                  {% else %}
                    -
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-warning">No hay datos para mostrar en el detalle.</p>
    {% endif %}
  </div>

  <div class="tab-pane fade {% if filtros.tab == 'resumen' %}show active{% endif %}" id="resumen">
    <h3 class="mt-4 text-white">Resumen Mensual</h3>

    {% if resumen_mensual and resumen_mensual.tabla %}
      <div class="table-responsive">
        <table class="table table-dark table-bordered table-hover text-center align-middle">
          <thead>
            <tr>
              <th>Producto</th>
              <th>Meses</th>
              {% for mes in meses %}
                <th>{{ mes }}</th>
              {% endfor %}
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            {% for fila in resumen_mensual.tabla %}
              <tr>
                <td rowspan="3" class="align-middle">{{ fila.producto }}</td>
                <td>Neto</td>
                {% for val in fila.neto %}
                  <td>{{ val }}</td>
                {% endfor %}
                <td>{{ fila.total_neto }}</td>
              </tr>
              <tr>
                <td>Cant.</td>
                {% for val in fila.cant %}
                  <td>{{ val }}</td>
                {% endfor %}
                <td>{{ fila.total_cant }}</td>
              </tr>
              <tr>
                <td>Unit.</td>
                {% for val in fila.unit %}
                  <td>{{ val }}</td>
                {% endfor %}
                <td>{{ fila.total_unit }}</td>
              </tr>
            {% endfor %}

            <tr class="table-secondary text-dark fw-bold">
              <td colspan="2">TOTAL</td>
              {% for val in resumen_mensual.total.neto %}
                <td>{{ val }}</td>
              {% endfor %}
              <td>{{ resumen_mensual.total.total_neto }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-warning">No hay datos para mostrar en el resumen mensual.</p>
    {% endif %}
  </div>
  <div class="tab-pane fade" id="detalle_dia">
    
    {% if detalle_dia_data and detalle_dia_data.tabla %}
      <h3 class="mt-4 text-white">{{ detalle_dia_data.titulo }}</h3>

      <div class="table-responsive">
        <table class="table table-dark table-hover table-bordered mt-3 text-center">
          <thead>
            <tr>
              <th>{{ filtros.filtro_por|title }}</th>

              {% for columna in detalle_dia_data.columnas %}
                <th>{{ columna }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for fila in detalle_dia_data.tabla %}
              <tr>
                <td>{{ fila[filtros.filtro_por] }}</td>

                {% for columna in detalle_dia_data.columnas %}
                  <td>
                    {% set valor = fila[columna] | default(0) %}
                    {{ "{:,.0f}".format(valor).replace(",", ".") }}
                  </td>
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

    {% else %}
      <h3 class="mt-4 text-white">Detalle por Día</h3>
      <p class="text-warning">No hay datos para mostrar con los filtros seleccionados.</p>
    {% endif %}

  </div>
</div>

<script>
  function actualizarLinkDescarga() {
    const form = document.querySelector("form");
    const params = new URLSearchParams(new FormData(form)).toString();
    document.getElementById("descargar-link").href = `/descargar_excel?${params}`;
  }

  // Guardar pestaña activa al hacer clic
  document.querySelectorAll('.nav-link[data-bs-toggle="tab"]').forEach(tab => {
    tab.addEventListener("click", function () {
      const href = tab.getAttribute("href").replace("#", "");
      document.getElementById("tab").value = href;
    });
  });

  window.onload = actualizarLinkDescarga;

  document.querySelectorAll("form select, form input").forEach(el => {
    el.addEventListener("change", actualizarLinkDescarga);
  });

  // Limpieza cruzada fechas-semana
  document.getElementById("desde").addEventListener("input", () => {
    document.getElementById("semana").value = "";
    document.getElementById("año").value = "";
  });
  document.getElementById("hasta").addEventListener("input", () => {
    document.getElementById("semana").value = "";
    document.getElementById("año").value = "";
  });
  document.getElementById("semana").addEventListener("input", () => {
    document.getElementById("desde").value = "";
    document.getElementById("hasta").value = "";
  });
  document.getElementById("año").addEventListener("input", () => {
    document.getElementById("desde").value = "";
    document.getElementById("hasta").value = "";
  });
</script>

<script>
  function actualizarLinkDescarga() {
    const form = document.querySelector("form");
    const params = new URLSearchParams(new FormData(form));

    // Identifica la pestaña activa (href="#detalle" o href="#resumen")
    const activeTabElement = document.querySelector(".nav-link.active");
    if (activeTabElement) {
        const activeTabHref = activeTabElement.getAttribute("href");
        const activeTab = activeTabHref.replace("#", ""); // "detalle" o "resumen"
        params.set("tab", activeTab);  // Agrega el parámetro tab
    }

    // Aplica los parámetros al href del botón de descarga
    document.getElementById("descargar-link").href = `/descargar_excel?${params.toString()}`;
  }

  // Ejecutar al cargar
  window.onload = actualizarLinkDescarga;

  // Ejecutar cuando se modifique algún filtro
  document.querySelectorAll("form select, form input").forEach(el => {
    el.addEventListener("change", actualizarLinkDescarga);
  });

  // Ejecutar también al cambiar de pestaña
  document.querySelectorAll('.nav-link').forEach(tab => {
    tab.addEventListener('shown.bs.tab', actualizarLinkDescarga);
  });
</script>

{% endblock %}
