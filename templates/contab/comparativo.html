{% extends "base.html" %}
{% block title %}Comparativo Contable{% endblock %}

{% block content %}
<h2 class="text-white">Comparativo Contable</h2>

<form method="GET" class="d-flex mb-3 gap-2 align-items-center flex-wrap">
  <label class="text-white mb-0 me-2">Fecha de corte:</label>
  <input type="date" name="fecha_corte" class="form-control w-auto" value="{{ fecha_corte }}">

  <select name="clasificacion" class="form-select w-auto">
    {% for c in ["Todas", "Activo", "Pasivo", "Gastos", "Ingresos"] %}
      <option value="{{ c }}" {% if c == clasificacion %}selected{% endif %}>{{ c }}</option>
    {% endfor %}
  </select>

  <select name="centro_costo" class="form-select w-auto">
    <option {% if centro_costo == 'Todos' %}selected{% endif %}>Todos</option>
    {% for cc in centros %}
        <option value="{{ cc }}" {% if centro_costo == cc %}selected{% endif %}>{{ cc }}</option>
    {% endfor %}
  </select>

  <button class="btn btn-danger">Aplicar</button>

  <!-- BotÃ³n de descarga alineado con el resto -->
  <a href="{{ url_for('contab.descargar_detalle', 
                      fecha_corte=fecha_corte,
                      clasificacion=clasificacion,
                      centro_costo=centro_costo) }}" 
     class="btn btn-success ms-2">
    Descargar Detalle
  </a>
</form>




<div class="table-responsive" style="max-height: 70vh; overflow-y: auto;">
  <table class="table table-dark table-bordered table-hover text-end align-middle">
    <thead>
      <tr>
        {% for col in columnas %}
          <th>{{ col }}</th>
        {% endfor %}
      </tr>
    </thead>
        <tbody>
        {% for fila in tabla %}
            <tr class="cuenta-principal" data-nombre="{{ fila['NOMBRE'] }}">
            {% for col in columnas %}
                <td>
                {% if col == "NOMBRE" %}
                    <strong><a href="#" class="toggle-detalle" data-nombre="{{ fila['NOMBRE'] }}" title="{{ fila['NOMBRE'] }}">{{ fila[col] }} </a></strong>
                {% else %}
                    {{ "{:,.0f}".format(fila[col]).replace(",", ".") }}
                {% endif %}
                </td>
            {% endfor %}
            </tr>

            <!-- Fila detalle oculta -->
            <tr class="detalle-row d-none" id="detalle-{{ fila['NOMBRE'] }}">
            <td colspan="{{ columnas|length }}">
                <table class="table table-sm table-bordered text-end mb-0">
                <thead>
                    <tr>
                    <th>Centro Costo</th>
                    {% for mes in columnas[1:] %}
                        <th>{{ mes }}</th>
                    {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for d in detalle if d['NOMBRE'] == fila['NOMBRE'] %}
                    <tr>
                        <td>{{ d['CENTRO COSTO'] }}</td>
                        {% for mes in columnas[1:] %}
                        <td>{{ "{:,.0f}".format(d.get(mes, 0)).replace(",", ".") }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
                </table>
            </td>
            </tr>
        {% endfor %}
        </tbody>

  </table>
</div>

<script>
document.querySelectorAll(".toggle-detalle").forEach(el => {
  el.addEventListener("click", function(e) {
    e.preventDefault();
    const nombre = this.dataset.nombre;
    const filaDetalle = document.getElementById("detalle-" + nombre);
    filaDetalle.classList.toggle("d-none");
  });
});
</script>


{% endblock %}
