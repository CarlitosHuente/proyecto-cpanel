{% extends "base.html" %}
{% block title %}Comparativo Gestión{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <h2 class="text-white m-0">Comparativo de Gestión</h2>
    
<form method="GET" class="d-flex align-items-center gap-2 bg-dark p-2 rounded border border-secondary flex-wrap">
        <select name="comp_cc" class="form-select form-select-sm bg-secondary text-white border-0" onchange="this.form.submit()">
            <option value="Total Empresa" {% if comp_cc == 'Total Empresa' %}selected{% endif %}>Total Empresa</option>
            {% for cc in todos_cc %}
                <option value="{{ cc }}" {% if comp_cc == cc %}selected{% endif %}>{{ cc }}</option>
            {% endfor %}
        </select>

        <div class="vr bg-secondary mx-1"></div>

        <select name="comp_modo" class="form-select form-select-sm bg-secondary text-white border-0" onchange="this.form.submit()">
            <option value="last_6" {% if comp_modo == 'last_6' %}selected{% endif %}>Últimos 6 Meses</option>
            <option value="last_12" {% if comp_modo == 'last_12' %}selected{% endif %}>Últimos 12 Meses</option>
            <option value="anual" {% if comp_modo == 'anual' %}selected{% endif %}>Comparativo Anual (Mismo mes)</option>
        </select>

        <div class="vr bg-secondary mx-1"></div>

        <div class="form-check form-switch m-0">
            <input class="form-check-input" type="checkbox" role="switch" id="switchSG" name="distribuir_sg" 
                   {% if switch_sg %}checked{% endif %} onchange="this.form.submit()">
            <label class="form-check-label text-white small" for="switchSG">Dist. SG</label>
        </div>

        <div class="form-check form-switch m-0">
            <input class="form-check-input" type="checkbox" role="switch" id="switchFab" name="ajuste_fabrica" 
                   {% if switch_fab %}checked{% endif %} onchange="this.form.submit()">
            <label class="form-check-label text-white small" for="switchFab">Aj. Fca</label>
        </div>
    </form>
</div>

<ul class="nav nav-tabs mb-3 border-secondary">
    <li class="nav-item">
        <a class="nav-link" href="{{ url_for('contab.dashboard_gestion') }}" style="color: #bbb;">
            Dashboard
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link" href="{{ url_for('contab.informe_gerencial') }}" 
        style="color: #bbb; border: 1px solid transparent;">
        Vista Mensual
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link active fw-bold" href="#" 
        style="background-color: #d80000; color: white; border-color: #d80000 #d80000 #000 #d80000;">
        Comparativo
        </a>
    </li>

</ul>

<div class="table-responsive shadow-sm" style="max-height: 75vh; overflow-y: auto;">
    <table class="table table-dark table-bordered table-hover align-middle table-sm" style="table-layout: fixed; width: 100%;">
        <thead class="sticky-top bg-black" style="z-index: 10;">
            <tr class="text-center small text-uppercase">
                <th class="bg-black text-start" style="width: 300px; min-width: 300px;">Concepto</th>
                {% for col in columnas %}
                    <th class="bg-black" style="min-width: 100px;">{{ col }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for seccion in reporte %}
                {% if seccion.tipo == 'macro' %}
                    <tr class="border-bottom border-secondary">
                        <td class="text-start fw-bold text-uppercase ps-3 text-light" style="background-color: #222;">
                            {{ seccion.titulo }}
                        </td>
                        {% for col in columnas %}
                            <td class="text-end fw-bold text-light" style="background-color: #222;">
                                {{ "{:,.0f}".format(seccion.totales_col[col]).replace(",", ".") }}
                            </td>
                        {% endfor %}
                    </tr>

                    {% for fila in seccion.grupos %}
                        {% set row_id = "fila_" ~ loop.index ~ "_" ~ seccion.titulo|replace(" ", "")|replace("/", "")|lower %}
                        
                        <tr class="grupo-row" style="cursor: pointer;" onclick="toggleFila('{{ row_id }}')">
                            <td class="text-start ps-4 text-nowrap" style="overflow: hidden; text-overflow: ellipsis;">
                                <span class="text-muted small me-1">▶</span>
                                {% if fila.tipo == 'INGRESO' %}
                                    <span class="text-success me-1 small">▲</span>
                                {% else %}
                                    <span class="text-danger me-1 small">▼</span>
                                {% endif %}
                                {{ fila.nombre }}
                            </td>
                            {% for col in columnas %}
                                {% set valor = fila.totales_col.get(col, 0) %}
                                <td class="text-end text-light {% if valor == 0 %}text-muted{% endif %}">
                                    {% if valor != 0 %}
                                        {{ "{:,.0f}".format(valor).replace(",", ".") }}
                                    {% else %}-{% endif %}
                                </td>
                            {% endfor %}
                        </tr>

                        <tr id="{{ row_id }}" class="d-none">
                            <td colspan="{{ columnas|length + 1 }}" class="p-0 border-0">
                                <table class="table table-sm table-dark table-hover mb-0" style="table-layout: fixed; width: 100%; background-color: #2c2c2c;">
                                    <tbody>
                                        {% for cta in fila.detalle_cuentas %}
                                            <tr>
                                                <td class="text-start ps-5 text-white" style="width: 300px; min-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                    <span class="font-monospace text-info me-2 small">{{ cta.codigo }}</span>
                                                    <span>{{ cta.nombre }}</span>
                                                </td>
                                                {% for col in columnas %}
                                                    {% set val_cta = cta.montos_col.get(col, 0) %}
                                                    <td class="text-end text-white" style="min-width: 100px;">
                                                        {% if val_cta != 0 %}{{ "{:,.0f}".format(val_cta).replace(",", ".") }}{% else %}<span class="text-muted small">.</span>{% endif %}
                                                    </td>
                                                {% endfor %}
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                    {% endfor %}

                {% elif seccion.tipo == 'calculo' %}
                    <tr class="border-top border-bottom border-white">
                        <td class="text-start fw-bold text-uppercase ps-3 bg-{{ seccion.color }} text-dark">
                            {{ seccion.titulo }}
                        </td>
                        {% for col in columnas %}
                            <td class="text-end fw-bold bg-{{ seccion.color }} text-dark">
                                {{ "{:,.0f}".format(seccion.totales_col[col]).replace(",", ".") }}
                            </td>
                        {% endfor %}
                    </tr>
                    <tr><td colspan="{{ columnas|length + 1 }}" class="bg-black border-0" style="height: 15px;"></td></tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() { restoreState(); });
    function toggleFila(id) {
        const filaDetalle = document.getElementById(id);
        if (filaDetalle) {
            const isHidden = filaDetalle.classList.contains('d-none');
            if (isHidden) { filaDetalle.classList.remove('d-none'); saveState(id, true); } 
            else { filaDetalle.classList.add('d-none'); saveState(id, false); }
        }
    }
    function saveState(id, isOpen) {
        let state = JSON.parse(localStorage.getItem('comp_estado_filas') || '{}');
        if (isOpen) state[id] = true; else delete state[id];
        localStorage.setItem('comp_estado_filas', JSON.stringify(state));
    }
    function restoreState() {
        const state = JSON.parse(localStorage.getItem('comp_estado_filas') || '{}');
        for (const id in state) {
            const fila = document.getElementById(id);
            if (fila) fila.classList.remove('d-none');
        }
    }
</script>

{% endblock %}