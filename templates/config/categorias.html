{% extends "base.html" %}

{% block content %}
<div class="container mt-4">

    <h2 class="text-white mb-4">
        <i class="bi bi-tags me-2"></i>Gestión de Categorías
    </h2>

    <div class="row">
        <div class="col-md-4 mb-3">
            <div class="card bg-dark border-secondary shadow h-100">
                <div class="card-header border-secondary text-white fw-bold">
                    Nueva Categoría
                </div>
                <div class="card-body">
                    <form action="{{ url_for('config.nueva_categoria') }}" method="POST">
                        <div class="mb-3">
                            <label class="form-label text-white">Nombre</label>
                            <input type="text" name="nombre_categoria" class="form-control" placeholder="Ej: Bebidas" required>
                        </div>
                        <button type="submit" class="btn btn-success w-100">
                            <i class="bi bi-plus-circle"></i> Agregar
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card bg-dark border-secondary shadow">
                <div class="card-body p-0">
                    <table class="table table-dark table-striped table-hover mb-0 align-middle">
                        <thead class="table-light text-dark">
                            <tr>
                                <th style="width: 50px;">ID</th>
                                <th style="width: 150px;">Categoría</th>
                                <th>Productos (Click para editar)</th>
                                <th class="text-end" style="width: 80px;">Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for c in categorias %}
                            <tr>
                                <td class="text-muted">{{ c.categoria_id }}</td>
                                <td class="fw-bold">{{ c.nombre_categoria }}</td>
                                
                                <td>
                                    {% set lista_prods = productos_map.get(c.categoria_id, []) %}
                                    
                                    {% if lista_prods %}
                                        <div class="d-flex flex-wrap gap-2">
                                            {% for prod in lista_prods %}
                                                <button onclick="abrirModalEdicion({{ prod.id }}, '{{ prod.nombre }}')" 
                                                        class="btn btn-sm btn-outline-info rounded-pill py-0 px-2"
                                                        style="font-size: 0.85rem;">
                                                    {{ prod.nombre }}
                                                </button>
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted small fst-italic">Sin productos</span>
                                    {% endif %}
                                </td>

                                <td class="text-end">
                                    <a href="{{ url_for('config.eliminar_categoria', id=c.categoria_id) }}" 
                                       class="btn btn-sm btn-outline-danger border-0"
                                       onclick="return confirm('¿Borrar categoría?')">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEdicionProducto" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content bg-dark border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title text-white" id="modalTitulo">Editar Producto</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body p-0">
        <iframe id="iframeEdicion" src="" style="width: 100%; height: 550px; border: none;"></iframe>
      </div>
    </div>
  </div>
</div>

<script>
    function abrirModalEdicion(idProducto, nombreProducto) {
        // 1. Cambiar título del modal
        document.getElementById('modalTitulo').innerText = 'Editando: ' + nombreProducto;
        
        // 2. Construir la URL de edición (Asegúrate que la ruta base coincida con tu app)
        // Flask genera urls tipo /config/productos/editar/123
        var urlBase = "{{ url_for('config.editar_producto', id=0) }}"; 
        var urlFinal = urlBase.replace('0', idProducto);
        
        // 3. Cargar URL en el iframe
        document.getElementById('iframeEdicion').src = urlFinal;
        
        // 4. Mostrar el modal
        var myModal = new bootstrap.Modal(document.getElementById('modalEdicionProducto'));
        myModal.show();
    }

    // Opcional: Recargar la página al cerrar el modal para ver cambios reflejados
    var myModalEl = document.getElementById('modalEdicionProducto')
    myModalEl.addEventListener('hidden.bs.modal', function (event) {
        // Limpiar iframe para que no parpadee lo anterior al volver a abrir
        document.getElementById('iframeEdicion').src = "";
        // Recargar página para actualizar nombres o categorías si cambiaron
        location.reload(); 
    })
</script>

{% endblock %}