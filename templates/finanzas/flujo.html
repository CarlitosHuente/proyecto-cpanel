{% extends 'base.html' %}

{% block title %}Flujo de Caja - HuentelauquÃ©n{% endblock %}

{% block content %}
<style>
    /* CORRECCIÃ“N ANCHO PRIMERA COLUMNA (260px) */
    .col-concepto {
        min-width: 260px !important;
        width: 260px !important;
        max-width: 260px !important;
        position: sticky;
        left: 0;
        background-color: #000; /* Fondo negro sÃ³lido */
        z-index: 100; /* Sobre las demÃ¡s celdas */
        border-right: 2px solid #444;
        white-space: normal !important; /* Texto en varias lÃ­neas si es largo */
    }
    
    .col-dato {
        min-width: 100px;
        text-align: right;
    }
    
    .col-total {
        min-width: 120px;
        background-color: #222;
        font-weight: bold;
        text-align: right;
        border-left: 2px solid #444;
    }

    /* Estilos Generales Tabla */
    .saldo-row td {
        background-color: #1a1a1a;
        font-weight: bold;
        border-top: 2px solid #555;
    }
    .fila-padre { cursor: pointer; background-color: #222; }
    .fila-padre:hover { background-color: #333; }
    .fila-hijo { background-color: #2c2c2c; font-size: 0.85rem; }
    .icon-expand { display: inline-block; width: 20px; text-align: center; }
</style>

<div class="container-fluid pt-3">
    
    <div class="row mb-3 align-items-center">
        <div class="col-md-4">
            <h4 class="text-white mb-0 text-uppercase">
                ðŸ’° Flujo: {{ nombre_mes }} {{ anio }}
            </h4>
        </div>
        
        <div class="col-md-4 text-center">
            <div class="btn-group" role="group">
                <a href="{{ url_for('finanzas.flujo', vista='diaria', mes=mes, anio=anio) }}" 
                   class="btn btn-sm {{ 'btn-light text-dark fw-bold' if vista == 'diaria' else 'btn-outline-secondary text-white' }}">
                   Diario
                </a>
                <a href="{{ url_for('finanzas.flujo', vista='semanal', mes=mes, anio=anio) }}" 
                   class="btn btn-sm {{ 'btn-light text-dark fw-bold' if vista == 'semanal' else 'btn-outline-secondary text-white' }}">
                   Semanal
                </a>
            </div>
        </div>

        <div class="col-md-4 text-end">
            <div class="btn-group">
                <a href="{{ url_for('finanzas.flujo', vista=vista, mes=mes-1 if mes > 1 else 12, anio=anio if mes > 1 else anio-1) }}" class="btn btn-outline-light btn-sm">â—€ Mes Ant.</a>
                <a href="{{ url_for('finanzas.flujo', vista=vista, mes=mes+1 if mes < 12 else 1, anio=anio if mes < 12 else anio+1) }}" class="btn btn-outline-light btn-sm">Mes Sig. â–¶</a>
            </div>
            <a href="{{ url_for('finanzas.pagos') }}" class="btn btn-danger btn-sm ms-2">
                + Nuevo Pago
            </a>
        </div>
    </div>

    <div class="table-responsive bg-dark border border-secondary" style="max-height: 80vh;">
        <table class="table table-dark table-bordered table-sm mb-0 align-middle">
            <thead class="text-center sticky-top" style="z-index: 101;">
                <tr>
                    <th class="col-concepto bg-black">Concepto</th>
                    {% for col in columnas %}
                    <th class="col-dato {{ 'bg-secondary text-dark' if col.es_finde else '' }}">
                        {{ col.titulo }}<br>
                        <small style="font-size: 0.7rem;">{{ col.subtitulo }}</small>
                    </th>
                    {% endfor %}
                    <th class="col-total">TOTAL</th>
                </tr>
            </thead>
            <tbody>
                
                {% set ns = namespace(saldo_actual = saldo_inicial_acumulado) %}
                
                <tr class="saldo-row text-info">
                    <td class="col-concepto">SALDO INICIAL</td>
                    {% for col in columnas %}
                        <td class="col-dato">
                            {{ "{:,.0f}".format(ns.saldo_actual).replace(',', '.') }}
                        </td>
                        {% set ingreso = totales_por_columna[col.id]['ingreso'] %}
                        {% set egreso = totales_por_columna[col.id]['egreso'] %}
                        {% set ns.saldo_actual = ns.saldo_actual + ingreso - egreso %}
                    {% endfor %}
                    <td class="col-total">-</td> 
                </tr>

                <tr class="text-success" style="font-size: 0.9rem;">
                    <td class="col-concepto ps-3">Total Ingresos (+)</td>
                    {% set ns_ingreso = namespace(total_row=0) %}
                    {% for col in columnas %}
                        {% set val = totales_por_columna[col.id]['ingreso'] %}
                        {% set ns_ingreso.total_row = ns_ingreso.total_row + val %}
                        <td class="col-dato">{{ "{:,.0f}".format(val).replace(',', '.') if val > 0 else '-' }}</td>
                    {% endfor %}
                    <td class="col-total text-success">{{ "{:,.0f}".format(ns_ingreso.total_row).replace(',', '.') }}</td>
                </tr>

                <tr class="text-warning" style="font-size: 0.9rem;">
                    <td class="col-concepto ps-3">Total Egresos (-)</td>
                    {% set ns_egreso = namespace(total_row=0) %}
                    {% for col in columnas %}
                        {% set val = totales_por_columna[col.id]['egreso'] %}
                        {% set ns_egreso.total_row = ns_egreso.total_row + val %}
                        <td class="col-dato">{{ "{:,.0f}".format(val).replace(',', '.') if val > 0 else '-' }}</td>
                    {% endfor %}
                    <td class="col-total text-warning">{{ "{:,.0f}".format(ns_egreso.total_row).replace(',', '.') }}</td>
                </tr>

                {% set ns = namespace(saldo_final = saldo_inicial_acumulado) %}
                <tr class="saldo-row text-white bg-secondary">
                    <td class="col-concepto">SALDO FINAL</td>
                    {% for col in columnas %}
                        {% set ingreso = totales_por_columna[col.id]['ingreso'] %}
                        {% set egreso = totales_por_columna[col.id]['egreso'] %}
                        {% set ns.saldo_final = ns.saldo_final + ingreso - egreso %}
                        <td class="col-dato border-top border-white">
                            {{ "{:,.0f}".format(ns.saldo_final).replace(',', '.') }}
                        </td>
                    {% endfor %}
                    <td class="col-total bg-secondary text-white">
                        {{ "{:,.0f}".format(ns.saldo_final).replace(',', '.') }}
                    </td>
                </tr>

                {% for tipo_key, items in data_view.items() %}
                    <tr class="table-secondary">
                        <td colspan="{{ columnas|length + 2 }}" class="fw-bold text-dark ps-3 text-uppercase">
                            DETALLE {{ tipo_key }}S
                        </td>
                    </tr>
                    
                    {% for item in items %}
                        <tr class="fila-padre" data-bs-toggle="collapse" data-bs-target=".cat-{{ item.info.id }}">
                            <td class="col-concepto {{ 'text-success' if tipo_key=='ingreso' else 'text-warning' }} fw-bold">
                                <span class="icon-expand">â–¼</span> {{ item.info.nombre }}
                            </td>
                            {% for col in columnas %}
                                {% set val = item.valores.get(col.id, 0) %}
                                <td class="col-dato {{ 'text-muted' if val == 0 else 'text-white' }}">
                                    {{ "{:,.0f}".format(val).replace(',', '.') if val > 0 else '-' }}
                                </td>
                            {% endfor %}
                            
                            <td class="col-total {{ 'text-success' if tipo_key=='ingreso' else 'text-warning' }}">
                                {{ "{:,.0f}".format(item.total_periodo).replace(',', '.') }}
                            </td>
                        </tr>

                        {% for sub_nombre, sub_data in item.subitems.items() %}
                        <tr class="collapse show cat-{{ item.info.id }} fila-hijo">
                            <td class="col-concepto ps-5">â†³ {{ sub_nombre }}</td>
                            {% for col in columnas %}
                                {% set val_sub = sub_data.valores.get(col.id, 0) %}
                                <td class="col-dato">
                                    {{ "{:,.0f}".format(val_sub).replace(',', '.') if val_sub > 0 else '' }}
                                </td>
                            {% endfor %}
                            <td class="col-total text-muted">
                                {{ "{:,.0f}".format(sub_data.total_sub).replace(',', '.') }}
                            </td>
                        </tr>
                        {% endfor %}
                    {% endfor %}
                {% endfor %}

            </tbody>
        </table>
    </div>
</div>

<script>
    document.querySelectorAll('.fila-padre').forEach(row => {
        row.addEventListener('click', function() {
            const icon = this.querySelector('.icon-expand');
            this.classList.toggle('collapsed');
            icon.innerHTML = this.classList.contains('collapsed') ? 'â–¶' : 'â–¼';
        });
    });
</script>

{% endblock %}